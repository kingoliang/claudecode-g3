---
name: iterative-workflow
description: 迭代式多 Agent 协作工作流。代码生成后自动检查，反馈改进，循环直到达标。
---

# 迭代式协作工作流

## 核心理念

```
写代码 → 检查 → 反馈 → 改进 → 再检查 → 循环直到达标
```

## 参与的 Agents

| Agent | 职责 |
|-------|------|
| code-writer | 编写和改进代码 |
| security-reviewer | 安全漏洞检测 (OWASP Top 10) |
| quality-checker | 代码质量检查 (复杂度、命名、结构) |
| performance-analyzer | 性能分析 (算法、N+1、内存) |
| result-aggregator | 汇总判定，生成改进反馈 |

## 工作流程

```
用户需求
    ↓
┌─────────────────────────────────────┐
│ Step 0: 技术栈加载                   │
│ - 检查 .claude/tech-stack.json      │
│ - 不存在 → 调用 /tech-stack 生成     │
│ - 存在 → 直接读取使用                │
└─────────────────────────────────────┘
    ↓
┌─────────────────────────────────────┐
│ Step 1: code-writer 生成代码         │
└─────────────────────────────────────┘
    ↓
┌────────────┬────────────┬───────────┐
│ security   │ quality    │ perform   │
│ -reviewer  │ -checker   │ -analyzer │
│ (并行执行)                           │
└────────────┴────────────┴───────────┘
    ↓
┌─────────────────────────────────────┐
│ Step 3: result-aggregator 汇总判定   │
└─────────────────────────────────────┘
    ↓
┌─────┴─────┐
↓           ↓
达标        未达标 → 反馈给 code-writer → 继续迭代
```

## 技术栈管理

技术栈配置存储在 `.claude/tech-stack.json`，由 `/tech-stack` 命令管理：

```bash
# 查看/生成技术栈配置
/tech-stack

# 强制重新检测
/tech-stack --refresh
```

**优势**:
- 首次检测后缓存，不重复检测
- 团队可共享同一份配置
- 用户可手动编辑调整

## 达标标准

| 维度 | 要求 | 权重 |
|------|------|------|
| Critical 问题 | 0 个 | 一票否决 |
| High 问题 | ≤ 2 个 | - |
| 安全评分 | ≥ 85 分 | 40% |
| 质量评分 | ≥ 80 分 | 35% |
| 性能评分 | ≥ 80 分 | 25% |
| **综合评分** | **≥ 80 分** | - |

## 迭代控制

| 参数 | 值 | 说明 |
|------|---|------|
| 最大迭代 | 5 轮 | 超过后建议人工介入 |
| 停滞检测 | 连续2轮 <5分提升 | 触发人工介入 |

## 使用方式

### 方式 1: 使用命令
```bash
/iterative-code 实现用户登录 API
```

### 方式 2: 与 OpenSpec 结合
```bash
/os-apply-iterative CHG-xxx
```

### 方式 3: 直接对话
```
用迭代式协作帮我实现文件上传功能
```

## 最佳实践

1. **明确需求** - 提供清晰的功能描述和技术约束
2. **控制范围** - 每次只实现一个功能点
3. **关注反馈** - 查看每轮迭代的改进建议
